<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>mechanoChemIGA: Example 4 : Coupled Cahn-Hilliard/Allen-Cahn</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">mechanoChemIGA
   &#160;<span id="projectnumber">0.2.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="codestructure.html"><span>Code&#160;structure</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li><a href="modules.html"><span>Functions</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="https://github.com/mechanoChem/mechanoChem"><span>GitHub&#160;code&#160;repo</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Example 4 : Coupled Cahn-Hilliard/Allen-Cahn </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This example implements the coupled Cahn-Hilliard and Allen-Cahn equations for phase-field modeling, as described by the following weak form of the PDE. The two scalar fields are composition, <img class="formulaInl" alt="$c$" src="form_5.png"/>, and an order parameter, <img class="formulaInl" alt="$\eta$" src="form_6.png"/>). Note the application of the higher-order Dirichlet boundary condition <img class="formulaInl" alt="$\nabla c\cdot\boldsymbol{n}=0$" src="form_7.png"/> using Nitsche's method.</p>
<p>Cahn-Hilliard:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} 0 &amp;=&amp; \int_\Omega \left(w_1\frac{c - c_{prev}}{\mathrm{d}t} + M\left(\nabla w_1\cdot(f_{,cc}\nabla c + f_{,c\eta}\nabla\eta) + \kappa_1\nabla^2 w_1\nabla^2 c\right)\right) dV\\ &amp;\phantom{=}&amp; - \int_{\partial\Omega} \left(w_1j_n + M\kappa_1\left(\nabla^2c(\nabla w_1\cdot\boldsymbol{n}) + \nabla^2w_1(\nabla c\cdot\boldsymbol{n})\right) - \tau(\nabla w_1\cdot\boldsymbol{n})(\nabla c\cdot\boldsymbol{n})\right) dS \end{eqnarray*}" src="form_9.png"/>
</p>
<p>Allen-Cahn:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} 0 &amp;=&amp; \int_\Omega \left(w_2\frac{\eta - \eta_{prev}}{\mathrm{d}t} + L\left(w_2 f_{,\eta} + \kappa_2\nabla w_2\cdot\nabla \eta\right)\right) dV \end{eqnarray*}" src="form_42.png"/>
</p>
<p>Free energy density:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} f(c,\eta) = (c - 0.1)^2(c - 0.9)^2\eta + (\eta - 0.2)^2(\eta-0.8)^2 \end{eqnarray*}" src="form_11.png"/>
</p>
<p>To implement this model, we will specify the following through defining user functions: <br/>
</p>
<ul>
<li>Initial conditions <br/>
</li>
<li>Constitutive model (via free energy density functions) <br/>
</li>
<li>Parameter values <br/>
</li>
<li>Weak form of the PDEs <br/>
</li>
</ul>
<p>First, we include the header file declaring the required user functions. These functions will be defined in this file.</p>
<p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="user_functions_8h.html">userFunctions.h</a>&quot;</span></div>
</div><!-- fragment --></p>
<p>Now, we first define any optional user functions. Optional user functions have a default definition that can be redefined by the user using a function pointer. This will be done in the <code>defineParameters</code> function. The available list of optional user functions includes: <code>boundaryConditions</code>, <code>scalarInitialConditions</code>, <code>vectorInitialConditions</code>, <code>loadStep</code>, <code>adaptiveTimeStep</code>, and <code>projectFields</code>. In this example, we redefine only the <code>scalarInitialConditions</code> function, while using the default functions for the others.</p>
<p><b> The <code>scalarInitialConditions</code> function </b></p>
<p>We initialized the composition and order parameters fields to be random about 0.5.</p>
<p><div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#a360bfcfddf6eb0952d9904c883f3f741">userScalarInitialConditions</a>(<span class="keyword">const</span> <a class="code" href="class_tensor.html">Tensor&lt;1,dim,double&gt;</a> &amp;x, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> scalar_i, <a class="code" href="struct_app_ctx.html">AppCtx&lt;dim&gt;</a> &amp;user)</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">switch</span>(scalar_i) {</div>
<div class="line">  <span class="keywordflow">case</span> 0: <span class="keywordflow">return</span> 0.5 + 0.1*(0.5 - (double)(rand() % 100 )/100.0); <span class="comment">//Random about 0.5</span></div>
<div class="line">  <span class="keywordflow">case</span> 1: <span class="keywordflow">return</span> 0.5 + 0.3*(0.5 - (double)(rand() % 100 )/100.0); <span class="comment">//Random about 0.5</span></div>
<div class="line">  <span class="keywordflow">default</span>: <span class="keywordflow">return</span> 0.;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">} <span class="comment">//end scalarInitialConditions</span></div>
</div><!-- fragment --></p>
<p><b> Free energy density derivative functions </b></p>
<p>This phase-field implementation requires several derivatives of the chemical free energy density function <img class="formulaInl" alt="$f(c,\eta) = (c - 0.1)^2(c - 0.9)^2\eta + (\eta - 0.2)^2(\eta-0.8)^2$" src="form_12.png"/>. We define the functions computing <img class="formulaInl" alt="$\partial f/\partial\eta$" src="form_13.png"/>, <img class="formulaInl" alt="$\partial^2 f/\partial c \partial c$" src="form_14.png"/>, and <img class="formulaInl" alt="$\partial^2 f/\partial\eta \partial c$" src="form_15.png"/> here. Note that these free energy derivative functions are used only in this file. They are not members of any class, nor will we use them to set any function pointers.</p>
<p><div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line">T <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#ad1838058dcdb7487706b8f5e55ce2217">F_eta</a>(T c, T eta){</div>
<div class="line">  <span class="keywordflow">return</span> std::pow(c-0.1,2)*std::pow(c-0.9,2) + 2.*(eta-0.2)*(eta-0.8)*(2.*eta-1.);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line">T <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#acf9953d272a25dde719af6ce9d2763cb">F_cc</a>(T c, T eta){</div>
<div class="line">  <span class="keywordflow">return</span> 2*eta*(std::pow(2.*c-1.,2) + 2.*(c-0.1)*(c-.9));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line">T <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#a5e324a2cfc6ffec7d625f60e8ebb73d7">F_ceta</a>(T c, T eta){</div>
<div class="line">  <span class="keywordflow">return</span> 2.*(c-0.1)*(c-0.9)*(2.*c-1.);</div>
<div class="line">} <span class="comment">//end free energy derivative functions</span></div>
</div><!-- fragment --></p>
<p><b> The <code>defineParameters</code> function </b></p>
<p>The user is required to define the <code>defineParameters</code> and <code>residual</code> functions. The <code>defineParameters</code> defines variables and functions in the <code>AppCtx</code> object. The <code>AppCtx</code> object is defined in the appCtx.h file. This function is used to define any values in <code>user</code> that will be needed in the problem. It is also used to set any function pointers for user functions that we have redefined.</p>
<p><div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__user_functions.html#gadbccf6631ad847d5a681a548f921ef29">defineParameters</a>(<a class="code" href="struct_app_ctx.html">AppCtx&lt;dim&gt;</a>&amp; user){</div>
</div><!-- fragment --></p>
<p>Here, we define the mesh by setting the number of elements in each direction, e.g. a 20x20 element mesh.</p>
<p><div class="fragment"><div class="line">  user.<a class="code" href="struct_app_ctx.html#a55ccabd543df9a0223cd34dbd64c987d">N</a>[0] = 20;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a55ccabd543df9a0223cd34dbd64c987d">N</a>[1] = 20;</div>
</div><!-- fragment --></p>
<p>We also define the dimensions of the domain, e.g. a unit square.</p>
<p><div class="fragment"><div class="line">  user.<a class="code" href="struct_app_ctx.html#a789652912f4d6df6c0836aa22ae93de0">L</a>[0] = 1.;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a789652912f4d6df6c0836aa22ae93de0">L</a>[1] = 1.;</div>
</div><!-- fragment --></p>
<p>We can define a periodic (or partially periodic) domain. The default is no periodicity in all directions. Here, we override the default and define periodicity in both the x and y directions.</p>
<p><div class="fragment"><div class="line">  user.<a class="code" href="struct_app_ctx.html#ac77e8a2af239ac3f36a49dfc69ad5c69">periodic</a>[0] = PETSC_TRUE;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#ac77e8a2af239ac3f36a49dfc69ad5c69">periodic</a>[1] = PETSC_TRUE;</div>
</div><!-- fragment --></p>
<p>We define the time step and total simulation time. We also have the options to use restart files, in which case we would set the iteration index and time at which to start. We leave these values at zero to begin a new simulation. We also have the option to output results at regular intervals (e.g. every 5 time steps).</p>
<p><div class="fragment"><div class="line">  user.<a class="code" href="struct_app_ctx.html#a4c155b92216444548c4457f18e050630">dtVal</a> = .1;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a17b4070be131d7cee7880bbc695f9169">totalTime</a> = 20;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a28a6be93b52da95fb5e891f10a9a5d87">RESTART_IT</a> = 0;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a6d5465cb515bc053db8785edd2e1b21b">RESTART_TIME</a> = 0.;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a7c81203929d679b6ee72dec416c9bea9">skipOutput</a> = 2;</div>
</div><!-- fragment --></p>
<p>We specify the number of vector and scalar solution and projection fields by adding the name of each field to their respective vector. Here, we have two scalar solution field (the composition and an order parameter). We do not use any vector solution fields or projection fields in this example.</p>
<p><div class="fragment"><div class="line">  user.<a class="code" href="struct_app_ctx.html#a6794fa3a8512e9239c9f2e4c7bf18ec3">scalarSolnFields</a>.push_back(<span class="stringliteral">&quot;c&quot;</span>);</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a6794fa3a8512e9239c9f2e4c7bf18ec3">scalarSolnFields</a>.push_back(<span class="stringliteral">&quot;eta&quot;</span>);</div>
</div><!-- fragment --></p>
<p>We can specify the polynomial order of the basis splines, as well as the global continuity. Note that the global continuity must be less than the polynomial order. Here, we use quadratic basis functions with C-1 global continuity.</p>
<p><div class="fragment"><div class="line">  user.<a class="code" href="struct_app_ctx.html#a23cded74ca3d8ec2f99d69e41d8539ca">polyOrder</a> = 2;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#ae091f872a8ec5d2a5492586ae8fcbcbb">globalContinuity</a> = 1;</div>
</div><!-- fragment --></p>
<p>Finally, we redirect the desired user function pointers to the <code>scalarInitialConditions</code> function that we defined above. This completes the <code>defineParameters</code> function.</p>
<p><div class="fragment"><div class="line">  user.<a class="code" href="struct_app_ctx.html#a4a4f8fca81419b6f43a612a72ed0a989">scalarInitialConditions</a> = <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#a360bfcfddf6eb0952d9904c883f3f741">userScalarInitialConditions</a>;</div>
<div class="line"></div>
<div class="line">} <span class="comment">//end defineParameters</span></div>
</div><!-- fragment --></p>
<p><b> The <code>residual</code> function </b></p>
<p>The residual function defines the residual that is to be driven to zero. This is the central function of the code. It is set up to follow the analytical weak form of the PDE. It has a number of arguments that give problem information at the current quadrature point.</p>
<p><div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim, <span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__user_functions.html#gab9195b3f02c923dafb2c742df293db7d">residual</a>(<span class="keywordtype">bool</span> dV,</div>
<div class="line">          <span class="keywordtype">bool</span> dS,</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="class_tensor.html">Tensor&lt;1,dim,double&gt;</a> &amp;x,</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="class_tensor.html">Tensor&lt;1,dim,double&gt;</a> &amp;normal,</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classsolution_scalars.html">solutionScalars&lt;dim,T&gt;</a> &amp;c,</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classsolution_vectors.html">solutionVectors&lt;dim,T&gt;</a> &amp;u,</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classtest_function_scalars.html">testFunctionScalars&lt;dim,T&gt;</a> &amp;w1,</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classtest_function_vectors.html">testFunctionVectors&lt;dim,T&gt;</a> &amp;w2,</div>
<div class="line">          <a class="code" href="struct_app_ctx.html">AppCtx&lt;dim&gt;</a> &amp;user,</div>
<div class="line">          Sacado::Fad::SimpleFad&lt;T&gt; &amp;r){</div>
</div><!-- fragment --></p>
<p><code>dV</code> is a boolean, "true" if <code>residual</code> is being called for the volume integral and "false" if <code>residual</code> is being called for the surface integral.<br/>
<code>dS</code> is a boolean, "false" if <code>residual</code> is being called for the volume integral and "true" if <code>residual</code> is being called for the surface integral.<br/>
<code>x</code> gives the coordinates of the quadrature point.<br/>
<code>normal</code> gives the unit normal for a surface quadrature point.<br/>
<code>c</code> gives the information (values, gradients, etc.) for the scalar solution fields at the current quadrature point (see documentation for solutionScalars class).<br/>
<code>u</code> gives the information (values, gradients, etc.) for the vector solution fields at the current quadrature point (see documentation for solutionVectors class).<br/>
<code>w1</code> gives the information for the scalar test functions.<br/>
<code>w2</code> gives the information for the vector test functions.<br/>
<code>user</code> is a structure available for parameters related to the initial boundary value problem (e.g. elasticity tensor).<br/>
<code>r</code> stores the scalar value of the residual for the weak form of the PDE which is then used by the core assembly functions.</p>
<p>The following functions are available for the solution objects <code>c</code> and <code>u</code>, where the argument is the field index, i.</p>
<p><code>c.val(i)</code> - Value of scalar field i, scalar <br/>
<code>c.grad(i)</code> - Gradient of scalar field i, 1st order tensor <br/>
<code>c.hess(i)</code> - Hessian of scalar field i, 2nd order tensor <br/>
<code>c.laplacian(i)</code> - Laplacian of scalar field i, scalar <br/>
<code>c.valP(i)</code> - Value of scalar field i at previous time step, scalar <br/>
<code>c.gradP(i)</code> - Gradient of scalar field i at previous time step, 1st order tensor <br/>
<code>c.hessP(i)</code> - Hessian of scalar field i at previous time step, 2nd order tensor <br/>
<code>c.laplacianP(i)</code> - Laplacian of scalar field i at previous time step, scalar</p>
<p><code>u.val(i)</code> - Value of vector field i, 1st order tensor <br/>
<code>u.grad(i)</code> - Gradient of vector field i, 2nd order tensor <br/>
<code>u.hess(i)</code> - Hessian of vector field i, 3rd order tensor <br/>
<code>u.valP(i)</code> - Value of vector field i at previous time step, 1st order tensor <br/>
<code>u.gradP(i)</code> - Gradient of vector field i at previous time step, 2nd order tensor <br/>
<code>u.hessP(i)</code> - Hessian of vector field i at previous time step, 3rd order tensor</p>
<p>Similar functions are available for the test functions. Also, the following tensor operations are useful:</p>
<p>Tensor operations: <br/>
<code>operator+</code> - tensor addition <br/>
<code>operator-</code> - tensor subraction <br/>
<code>operator*</code> - single contraction between tensors or scalar multiplication <br/>
<code>double_contract</code> - double contraction of two 2nd order tensors, or a 4th order tensor and a 2nd order tensor. <br/>
<code>trans( )</code> - transpose 2nd order tensor <br/>
<code>trace( )</code> - trace of 2nd order tensor <br/>
<code>det( )</code> - determinant of 2nd order tensor <br/>
<code>inv( )</code> - inverse of 2nd order tensor <br/>
 The example code here implements the weak form for the coupled Cahn-Hilliard and Allen-Cahn equations, as shown above.</p>
<p>First, we set the values for necessary parameters.</p>
<p><div class="fragment"><div class="line">  <span class="keywordtype">double</span> dt = user.<a class="code" href="struct_app_ctx.html#a102ae36ef6e9df9f12c7e988659b5ff0">dt</a>;</div>
<div class="line">  <span class="keywordtype">double</span> jn = 0;</div>
<div class="line">  <span class="keywordtype">double</span> M = .1, L = 2.; <span class="comment">//Mobility</span></div>
<div class="line">  <span class="keywordtype">double</span> kappa1 = .0005, kappa2 = .0005;</div>
<div class="line">  <span class="keywordtype">double</span> tau = 0.1*user.<a class="code" href="struct_app_ctx.html#a55ccabd543df9a0223cd34dbd64c987d">N</a>[0]/user.<a class="code" href="struct_app_ctx.html#a789652912f4d6df6c0836aa22ae93de0">L</a>[0];</div>
</div><!-- fragment --></p>
<p>Next, we get the values for the free energy derivatives <img class="formulaInl" alt="$f_{,cc}$" src="form_16.png"/>, <img class="formulaInl" alt="$f_{,c\eta}$" src="form_17.png"/>, and <img class="formulaInl" alt="$f_{,\eta}$" src="form_18.png"/> based on the current quadrature point.</p>
<p><div class="fragment"><div class="line">  T f_cc, f_ceta, f_eta;</div>
<div class="line">  f_cc = <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#acf9953d272a25dde719af6ce9d2763cb">F_cc</a>(c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(0),c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(1));</div>
<div class="line">  f_ceta = <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#a5e324a2cfc6ffec7d625f60e8ebb73d7">F_ceta</a>(c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(0),c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(1));</div>
<div class="line">  f_eta = <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#ad1838058dcdb7487706b8f5e55ce2217">F_eta</a>(c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(0),c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(1));</div>
</div><!-- fragment --></p>
<p>Now, we compute the residual in a manner very similar to the analytical form. First, the weak form of the Cahn-Hilliard equation:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} 0 &amp;=&amp; \int_\Omega \left(w_1\frac{c - c_{prev}}{\mathrm{d}t} + M\left(\nabla w_1\cdot(f_{,cc}\nabla c + f_{,c\eta}\nabla\eta) + \kappa_1\nabla^2 w_1\nabla^2 c\right)\right) dV\\ &amp;\phantom{=}&amp; - \int_{\partial\Omega} \left(w_1j_n + M\kappa_1\left(\nabla^2c(\nabla w_1\cdot\boldsymbol{n}) + \nabla^2w_1(\nabla c\cdot\boldsymbol{n})\right) - \tau(\nabla w_1\cdot\boldsymbol{n})(\nabla c\cdot\boldsymbol{n})\right) dS \end{eqnarray*}" src="form_9.png"/>
</p>
<p><div class="fragment"><div class="line">  r = ( w1.<a class="code" href="classtest_function_scalars.html#ad76f9644680c80e6602ccf460600b3a3">val</a>(0)*(c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(0) - c.<a class="code" href="classsolution_scalars.html#aa4c4b85dc344e177b1cbeca4bd59f0e8">valP</a>(0))/dt )*dV;  </div>
<div class="line">  r += ( M*w1.<a class="code" href="classtest_function_scalars.html#a40dbbf7383a6a9471d897f455405315d">grad</a>(0)*(f_cc*c.<a class="code" href="classsolution_scalars.html#a94a7f34ce00b9f6c3584756b185b320b">grad</a>(0) + f_ceta*c.<a class="code" href="classsolution_scalars.html#a94a7f34ce00b9f6c3584756b185b320b">grad</a>(1)))*dV;</div>
<div class="line">  r += M*kappa1*w1.<a class="code" href="classtest_function_scalars.html#a97d1e6abaec05fc0971181ad38af50fd">laplacian</a>(0)*c.<a class="code" href="classsolution_scalars.html#aaede18812f64934bc57ba259320d1240">laplacian</a>(0)*dV;</div>
<div class="line">  </div>
<div class="line">  r += -w1.<a class="code" href="classtest_function_scalars.html#ad76f9644680c80e6602ccf460600b3a3">val</a>(0)*jn*dS; <span class="comment">//Boundary flux</span></div>
<div class="line">  r += -M*kappa1*( c.<a class="code" href="classsolution_scalars.html#aaede18812f64934bc57ba259320d1240">laplacian</a>(0)*(w1.<a class="code" href="classtest_function_scalars.html#a40dbbf7383a6a9471d897f455405315d">grad</a>(0)*normal) + w1.<a class="code" href="classtest_function_scalars.html#a97d1e6abaec05fc0971181ad38af50fd">laplacian</a>(0)*(c.<a class="code" href="classsolution_scalars.html#a94a7f34ce00b9f6c3584756b185b320b">grad</a>(0)*normal) )*dS;</div>
<div class="line">  r += tau*(w1.<a class="code" href="classtest_function_scalars.html#a40dbbf7383a6a9471d897f455405315d">grad</a>(0)*normal)*(c.<a class="code" href="classsolution_scalars.html#a94a7f34ce00b9f6c3584756b185b320b">grad</a>(0)*normal)*dS;</div>
</div><!-- fragment --></p>
<p>And finally, the Allen-Cahn equation, which completes the residual function.</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} 0 &amp;=&amp; \int_\Omega \left(w_2\frac{\eta - \eta_{prev}}{\mathrm{d}t} + L\left(w_2 f_{,\eta} + \kappa_2\nabla w_2\cdot\nabla \eta\right)\right) dV \end{eqnarray*}" src="form_42.png"/>
</p>
<p> <div class="fragment"><div class="line">  r += ( w1.<a class="code" href="classtest_function_scalars.html#ad76f9644680c80e6602ccf460600b3a3">val</a>(1)*(c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(1) - c.<a class="code" href="classsolution_scalars.html#aa4c4b85dc344e177b1cbeca4bd59f0e8">valP</a>(1))/dt )*dV;</div>
<div class="line">  r += L*( w1.<a class="code" href="classtest_function_scalars.html#ad76f9644680c80e6602ccf460600b3a3">val</a>(1)*f_eta + kappa2*(w1.<a class="code" href="classtest_function_scalars.html#a40dbbf7383a6a9471d897f455405315d">grad</a>(1)*c.<a class="code" href="classsolution_scalars.html#a94a7f34ce00b9f6c3584756b185b320b">grad</a>(1)) )*dV;</div>
<div class="line">  </div>
<div class="line">} <span class="comment">//end residual</span></div>
</div><!-- fragment --></p>
<p>Finally, we include a file that instatiates the template functions <code>defineParameters</code> and <code>residual</code>. This bit of code will generally be the same for any problem (unless you decide to use a different automatic differentation library), the user does not need to modify it.</p>
<p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="user_functions_instantiation_8h.html">userFunctionsInstantiation.h</a>&quot;</span></div>
</div><!-- fragment --></p>
<h1>The complete code </h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="user_functions_8h.html">userFunctions.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#a360bfcfddf6eb0952d9904c883f3f741">userScalarInitialConditions</a>(<span class="keyword">const</span> <a class="code" href="class_tensor.html">Tensor&lt;1,dim,double&gt;</a> &amp;x, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> scalar_i, <a class="code" href="struct_app_ctx.html">AppCtx&lt;dim&gt;</a> &amp;user)</div>
<div class="line">{</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">switch</span>(scalar_i) {</div>
<div class="line">  <span class="keywordflow">case</span> 0: <span class="keywordflow">return</span> 0.5 + 0.1*(0.5 - (double)(rand() % 100 )/100.0); <span class="comment">//Random about 0.5</span></div>
<div class="line">  <span class="keywordflow">case</span> 1: <span class="keywordflow">return</span> 0.5 + 0.3*(0.5 - (double)(rand() % 100 )/100.0); <span class="comment">//Random about 0.5</span></div>
<div class="line">  <span class="keywordflow">default</span>: <span class="keywordflow">return</span> 0.;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">} <span class="comment">//end scalarInitialConditions</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line">T <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#ad1838058dcdb7487706b8f5e55ce2217">F_eta</a>(T c, T eta){</div>
<div class="line">  <span class="keywordflow">return</span> std::pow(c-0.1,2)*std::pow(c-0.9,2) + 2.*(eta-0.2)*(eta-0.8)*(2.*eta-1.);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line">T <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#acf9953d272a25dde719af6ce9d2763cb">F_cc</a>(T c, T eta){</div>
<div class="line">  <span class="keywordflow">return</span> 2*eta*(std::pow(2.*c-1.,2) + 2.*(c-0.1)*(c-.9));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line">T <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#a5e324a2cfc6ffec7d625f60e8ebb73d7">F_ceta</a>(T c, T eta){</div>
<div class="line">  <span class="keywordflow">return</span> 2.*(c-0.1)*(c-0.9)*(2.*c-1.);</div>
<div class="line">} <span class="comment">//end free energy derivative functions</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__user_functions.html#gadbccf6631ad847d5a681a548f921ef29">defineParameters</a>(<a class="code" href="struct_app_ctx.html">AppCtx&lt;dim&gt;</a>&amp; user){</div>
<div class="line"> </div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a55ccabd543df9a0223cd34dbd64c987d">N</a>[0] = 20;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a55ccabd543df9a0223cd34dbd64c987d">N</a>[1] = 20;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a789652912f4d6df6c0836aa22ae93de0">L</a>[0] = 1.;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a789652912f4d6df6c0836aa22ae93de0">L</a>[1] = 1.;</div>
<div class="line"></div>
<div class="line">  <span class="comment">//Set the domain to be periodic in the x and y directions</span></div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#ac77e8a2af239ac3f36a49dfc69ad5c69">periodic</a>[0] = PETSC_TRUE;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#ac77e8a2af239ac3f36a49dfc69ad5c69">periodic</a>[1] = PETSC_TRUE;</div>
<div class="line"></div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a4c155b92216444548c4457f18e050630">dtVal</a> = .1;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a17b4070be131d7cee7880bbc695f9169">totalTime</a> = 20;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a28a6be93b52da95fb5e891f10a9a5d87">RESTART_IT</a> = 0;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a6d5465cb515bc053db8785edd2e1b21b">RESTART_TIME</a> = 0.;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a7c81203929d679b6ee72dec416c9bea9">skipOutput</a> = 2;</div>
<div class="line"></div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a6794fa3a8512e9239c9f2e4c7bf18ec3">scalarSolnFields</a>.push_back(<span class="stringliteral">&quot;c&quot;</span>);</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a6794fa3a8512e9239c9f2e4c7bf18ec3">scalarSolnFields</a>.push_back(<span class="stringliteral">&quot;eta&quot;</span>);</div>
<div class="line"></div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a23cded74ca3d8ec2f99d69e41d8539ca">polyOrder</a> = 2;</div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#ae091f872a8ec5d2a5492586ae8fcbcbb">globalContinuity</a> = 1;</div>
<div class="line"></div>
<div class="line">  user.<a class="code" href="struct_app_ctx.html#a4a4f8fca81419b6f43a612a72ed0a989">scalarInitialConditions</a> = <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#a360bfcfddf6eb0952d9904c883f3f741">userScalarInitialConditions</a>;</div>
<div class="line"></div>
<div class="line">} <span class="comment">//end defineParameters</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim, <span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__user_functions.html#gab9195b3f02c923dafb2c742df293db7d">residual</a>(<span class="keywordtype">bool</span> dV,</div>
<div class="line">          <span class="keywordtype">bool</span> dS,</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="class_tensor.html">Tensor&lt;1,dim,double&gt;</a> &amp;x,</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="class_tensor.html">Tensor&lt;1,dim,double&gt;</a> &amp;normal,</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classsolution_scalars.html">solutionScalars&lt;dim,T&gt;</a> &amp;c,</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classsolution_vectors.html">solutionVectors&lt;dim,T&gt;</a> &amp;u,</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classtest_function_scalars.html">testFunctionScalars&lt;dim,T&gt;</a> &amp;w1,</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classtest_function_vectors.html">testFunctionVectors&lt;dim,T&gt;</a> &amp;w2,</div>
<div class="line">          <a class="code" href="struct_app_ctx.html">AppCtx&lt;dim&gt;</a> &amp;user,</div>
<div class="line">          Sacado::Fad::SimpleFad&lt;T&gt; &amp;r){</div>
<div class="line"></div>
<div class="line">  <span class="comment">//Chemistry</span></div>
<div class="line">  <span class="keywordtype">double</span> dt = user.<a class="code" href="struct_app_ctx.html#a102ae36ef6e9df9f12c7e988659b5ff0">dt</a>;</div>
<div class="line">  <span class="keywordtype">double</span> jn = 0;</div>
<div class="line">  <span class="keywordtype">double</span> M = .1, L = 2.; <span class="comment">//Mobility</span></div>
<div class="line">  <span class="keywordtype">double</span> kappa1 = .0005, kappa2 = .0005;</div>
<div class="line">  <span class="keywordtype">double</span> tau = 0.1*user.<a class="code" href="struct_app_ctx.html#a55ccabd543df9a0223cd34dbd64c987d">N</a>[0]/user.<a class="code" href="struct_app_ctx.html#a789652912f4d6df6c0836aa22ae93de0">L</a>[0];</div>
<div class="line">  </div>
<div class="line">  <span class="comment">//Get chemical potential and derivatives</span></div>
<div class="line">  T f_cc, f_ceta, f_eta;</div>
<div class="line">  f_cc = <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#acf9953d272a25dde719af6ce9d2763cb">F_cc</a>(c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(0),c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(1));</div>
<div class="line">  f_ceta = <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#a5e324a2cfc6ffec7d625f60e8ebb73d7">F_ceta</a>(c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(0),c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(1));</div>
<div class="line">  f_eta = <a class="code" href="_cahn_hilliard___allen_cahn_22_d_2user_functions_8cc.html#ad1838058dcdb7487706b8f5e55ce2217">F_eta</a>(c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(0),c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(1));</div>
<div class="line">  </div>
<div class="line">  <span class="comment">//Cahn-Hilliard with Nitche&#39;s method</span></div>
<div class="line">  r = ( w1.<a class="code" href="classtest_function_scalars.html#ad76f9644680c80e6602ccf460600b3a3">val</a>(0)*(c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(0) - c.<a class="code" href="classsolution_scalars.html#aa4c4b85dc344e177b1cbeca4bd59f0e8">valP</a>(0))/dt )*dV;  </div>
<div class="line">  r += ( M*w1.<a class="code" href="classtest_function_scalars.html#a40dbbf7383a6a9471d897f455405315d">grad</a>(0)*(f_cc*c.<a class="code" href="classsolution_scalars.html#a94a7f34ce00b9f6c3584756b185b320b">grad</a>(0) + f_ceta*c.<a class="code" href="classsolution_scalars.html#a94a7f34ce00b9f6c3584756b185b320b">grad</a>(1)))*dV;</div>
<div class="line">  r += M*kappa1*w1.<a class="code" href="classtest_function_scalars.html#a97d1e6abaec05fc0971181ad38af50fd">laplacian</a>(0)*c.<a class="code" href="classsolution_scalars.html#aaede18812f64934bc57ba259320d1240">laplacian</a>(0)*dV;</div>
<div class="line">  </div>
<div class="line">  r += -w1.<a class="code" href="classtest_function_scalars.html#ad76f9644680c80e6602ccf460600b3a3">val</a>(0)*jn*dS; <span class="comment">//Boundary flux</span></div>
<div class="line">  r += -M*kappa1*( c.<a class="code" href="classsolution_scalars.html#aaede18812f64934bc57ba259320d1240">laplacian</a>(0)*(w1.<a class="code" href="classtest_function_scalars.html#a40dbbf7383a6a9471d897f455405315d">grad</a>(0)*normal) + w1.<a class="code" href="classtest_function_scalars.html#a97d1e6abaec05fc0971181ad38af50fd">laplacian</a>(0)*(c.<a class="code" href="classsolution_scalars.html#a94a7f34ce00b9f6c3584756b185b320b">grad</a>(0)*normal) )*dS;</div>
<div class="line">  r += tau*(w1.<a class="code" href="classtest_function_scalars.html#a40dbbf7383a6a9471d897f455405315d">grad</a>(0)*normal)*(c.<a class="code" href="classsolution_scalars.html#a94a7f34ce00b9f6c3584756b185b320b">grad</a>(0)*normal)*dS;</div>
<div class="line">  </div>
<div class="line">  <span class="comment">//Allen-Cahn</span></div>
<div class="line">  r += ( w1.<a class="code" href="classtest_function_scalars.html#ad76f9644680c80e6602ccf460600b3a3">val</a>(1)*(c.<a class="code" href="classsolution_scalars.html#aad0d4f18ccffe03f32a1ac985eb3b3d8">val</a>(1) - c.<a class="code" href="classsolution_scalars.html#aa4c4b85dc344e177b1cbeca4bd59f0e8">valP</a>(1))/dt )*dV;</div>
<div class="line">  r += L*( w1.<a class="code" href="classtest_function_scalars.html#ad76f9644680c80e6602ccf460600b3a3">val</a>(1)*f_eta + kappa2*(w1.<a class="code" href="classtest_function_scalars.html#a40dbbf7383a6a9471d897f455405315d">grad</a>(1)*c.<a class="code" href="classsolution_scalars.html#a94a7f34ce00b9f6c3584756b185b320b">grad</a>(1)) )*dV;</div>
<div class="line">  </div>
<div class="line">} <span class="comment">//end residual</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="user_functions_instantiation_8h.html">userFunctionsInstantiation.h</a>&quot;</span></div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
